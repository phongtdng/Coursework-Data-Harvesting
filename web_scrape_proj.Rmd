---
title: "Pink Tax Spain"
author: "Phong Duong, Nienke Visscher"
date: "2024-02-15"
output: html_document
---

# Library

```{r}
library(xml2)
library(tidyverse)
library(RSelenium)
library(glue)
```

# Mercadona

```{r}

```

# Clarel

### Data Collection

```{r}
driver <- rsDriver(browser = "firefox",
                   chromever = NULL,
                   verbose = F)

remDr <- driver[["client"]]
```

#### Main Webpage

```{r}
clarel_url <- "https://www.clarel.es/es/"

remDr$navigate(clarel_url)

Sys.sleep(4)

#Reject cookie
remDr$findElement(using = "xpath", "//button[contains(@class, 'info_cookie-consent-reject-button')]")$clickElement()
```

#### Scrape Hombre Category

```{r}
get_subcat2_url <- function(category){
  remDr$getPageSource()[[1]] %>% 
    read_html() %>% 
    xml_find_all(glue("//span[a[contains(text(),'{category}')]]//li/a[contains(@class,'item')]")) %>% 
    xml_attr("href") %>% 
    paste0("https://www.clarel.es",.)
}
sub_cat_2_url <- get_subcat2_url("Hombre")

remDr$navigate(sub_cat_2_url[10])
```

```{r}
#Load more items
load_all_items <- function() {
  Sys.sleep(3.5)
  tryCatch(
    {
      suppressMessages({
      load_more_button <-remDr$findElement(using = "xpath", 
                                          "//button[contains(@class, 'load-more-items-button')]")
      while(load_more_button$isElementDisplayed()[[1]]) {
      load_more_button$clickElement()
      Sys.sleep(3.5)
      load_more_button <-remDr$findElement(using = "xpath", 
                                           "//button[contains(@class, 'load-more-items-button')]")
      }
      })
    },
    error = function(e){})
}

# load_all_items()
```

```{r}
#Get all product info
get_product_info <- function(url) {
  remDr$navigate(url)
  
  load_all_items()
  
  paths <- read_html(remDr$getPageSource()[[1]]) %>% 
  xml_find_all("//div[contains(@class, 'box_product-info')]")
  
  get_info <- function(path) {
  brand <- path %>% 
    xml_find_all("div[contains(@class, 'product-featuredbrands')]") %>%
    xml_text()
  
  product_name <- path %>% 
    xml_find_all("a") %>% 
    xml_text()
  
  price <- path %>% 
    xml_find_all("div[contains(@class, 'product-price')]/span[contains(@class,'final-price')]") %>% 
    xml_text()
  
  data.frame(
    brand = brand,
    product_name = product_name,
    price = price
  )
  }
  
  #Get cat & subcats
  cat <- remDr$getPageSource()[[1]] %>% 
    read_html() %>% 
    xml_find_all("//span[@class='subcategory']") %>% 
    xml_text() %>% 
    paste(collapse = ",")
  
  df <- map_dfr(paths, get_info) %>% mutate(full_cat = cat)

  
  return(df)
}


hombre_products <- map_dfr(sub_cat_2_url, get_product_info)

hombre_products
```

#### Scrape Multiple Categories

```{r}
imp_cat <- c("Hombre", "Higiene", "Cabello")

scrape_all <- function(category) {
  remDr$navigate(clarel_url)
  
  subcat2 <- get_subcat2_url(category)
  
  df <- map_dfr(subcat2, get_product_info) 
  
  return(df)
}

start <- Sys.time()
all_products_clarel <- map_dfr(imp_cat ,scrape_all)
stop <- Sys.time()

write_csv(all_products_clarel, "datasets/clarel.csv")
```

### Data Cleaning

```{r}
all_products_clarel <- read_csv("datasets/clarel.csv")

#Quantity detect
all_products_clarel %>% 
  as_tibble() %>% 
  mutate(
    quantity = str_extract(tolower(product_name), 
                           "\\d+ ?ml|\\d+ ?g|\\d+ ?u(ds)?|\\d+(,\\d+)? ?l"), .after = product_name
    ) 
```
