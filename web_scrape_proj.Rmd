---
title: "Pink Tax Spain"
author: "Phong Duong, Nienke Visscher"
date: "2024-02-15"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Library

```{r}
library(xml2)
library(tidyverse)
library(RSelenium)
library(glue)
library(magrittr)
library(httr)
library(sf)
library(rnaturalearth)
library(scrapex)
library(lubridate)
library(dplyr)
library(tidyr)
```

## Mercadona

### Setting up RSelenium

```{r}
set_config(
  user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36; Nienke Visscher / nienvis@gmail.com")
)

#Code for attaching JAVA
#Sys.getenv("JAVA_HOME")
#Sys.setenv(JAVA_HOME = "C:/Program Files/Common Files/Oracle/Java/javapath/java.exe")
#Sys.getenv("PATH")
#install.packages("RSelenium", dependencies = TRUE)

#Opening hidden browser
remDr <- rsDriver(port = 4464L, browser = "firefox",  verbose=F, chromever = NULL)


merc <-"https://tienda.mercadona.es/categories"

browseURL(prep_browser(merc))
 
remDr$client$navigate(merc)


```

### Obtaining URLs
#### Clicking through opening page

```{r}
driver <- remDr$client

#Note following only when having newly initiated the port
#Accepting cookies
driver$findElement(value = "(//button[@class = 'ui-button ui-button--small ui-button--tertiary ui-button--positive'])[1]")$clickElement()

#Click on text box
driver$findElement(value = "(//input[@class = 'ym-hide-content'])[1]")$clickElement()

#Define findElement of the textbox
codigo <-driver$findElement(value = "(//input[@class = 'ym-hide-content'])[1]")

#Fill in the text box
codigo$sendKeysToElement(list("28014"))

#Click 
driver$findElement(value = "(//button[@class = 'button button-primary button-big'])[1]")$clickElement()

##### Until here

```

#### Obtain the URLs per category
```{r}

#Get URLs 'Cuidado del cabello'

#Create an empty list to store the URLs 
url <- list()

#Navigate to the button 'Cuidado del cabello'
driver$findElement(value = "(//label[@class='subhead1-r' and contains(text(), 'Cuidado del cabello')])[1]")$clickElement()

#Use system sleep to avoid code running faster than the internet
Sys.sleep(1)

#Store the first URL
url[1] <-driver$getCurrentUrl()

#Create a loop to click on the button at the end of the page to naviagte to the next category and save the url
for (i in (2:4)){
  
  driver$findElement(value = "(//button[@class = 'ui-button ui-button--big ui-button--secondary ui-button--positive category-detail__next-subcategory'])[1]")$clickElement()
  
Sys.sleep(1)
  
  url[i] <-driver$getCurrentUrl()
  
  
}

#Get URLs Cuidado facial y corporal
  
driver$findElement(value = "(//label[@class='subhead1-r' and contains(text(), 'Cuidado facial y corporal')])[1]")$clickElement()

Sys.sleep(1)

url[5] <-driver$getCurrentUrl()



for (i in (6:15)){
  
  
  driver$findElement(value = "(//button[@class = 'ui-button ui-button--big ui-button--secondary ui-button--positive category-detail__next-subcategory'])[1]")$clickElement()
  
  Sys.sleep(1)
  
  url[i] <-driver$getCurrentUrl()
  
}

#Unlist the URL variable
url <-unlist(url)


```

#Scraping and cleaning data 
```{r}

#Create function
cat_grabber <- function(url){
  
#Navigate to one of the URLs stored in the variable URL
driver$navigate(url)
  
#Use system sleep to avoid code running faster than the internet
Sys.sleep(1)

#Get the page source code and read the html
cat_html <-driver$getPageSource()[[1]] |>
  read_html()

#Collect data on products
cat_info <- cat_html|> 
    xml_find_all("//*[@id='root']//button/div[2]") |>
    xml_text()

#Collect the sub category names
subcat_name <- cat_html |> 
   xml_find_all("//h1[@class='category-detail__title title1-b']") |>
   xml_text()

#Clean and separate data using regex
cat_clean<-cat_info|> 
  str_replace_all("\\€ |/|\\.|!", "") |>
  str_replace_all("\\€\\d+,\\d+", "") |>
  str_replace_all("(?<=\\d\\s)ml", "/ml/") |> 
  str_replace_all("(?<=\\d\\s)ud", "/ud/") |> 
  str_replace_all("(?<=\\d\\s{0,2})ud", "/ud/") |> 
  str_replace_all("(?<=\\d\\s)L", "/L/") |> 
  str_replace_all("(?<=\\d\\s)tarro", "") |> 
  str_replace_all("(?<=\\d\\s)g\\s", "/g/") |> 
  str_replace_all("(?<=\\d\\s)g", "/g/") |> 
  str_replace_all("(?<=\\d\\s)sobres", "/sobres/") |> 
  str_replace_all("(?<=\\d\\s)bandas", "/bandas/") |> 
  str_replace_all("(?<=sensibleCaja\\s)1", "/") |> 
  str_replace_all("(?<=DovePaquete\\s)4", "/") |> 
  str_replace_all("ud.(?=\\s*\\()", "") |> 
  str_replace_all("\\s(?=\\d+\\s*/)", "/") |> 
  str_replace_all("(?<=[[:lower:]])(?=[[:digit:]])", "/") |> 
  str_replace_all("\\(|\\)", "") |> 
  str_replace_all("\\.", "")|> 
  strsplit("/")


#Make all variables length 5 to create NA for missing values 
#cat_clean <- lapply(cat_clean, function(x) {
  #length(x) <- 5
  #x
#})

#Only keep the variables with 5 or less strings
cat_clean<- cat_clean[lengths(cat_clean) == 5]

#Create a dataframe
data.frame(
  name = sapply(cat_clean, `[`, 1),
  quantity = sapply(cat_clean, `[`, 2),
  quantity_unit = sapply(cat_clean, `[`, 3),
  price = sapply(cat_clean, `[`, 4),
  ud =  sapply(cat_clean, `[`, 5),
  subcat =  sapply(subcat_name, `[`, 1),
  stringsAsFactors = FALSE
)


}

cat_grabber(url)

#Loop thhe function cat_grabber over all URLs
final <- map_dfr(url, cat_grabber) 

```


### Scrape and add main categories to data frame
```{r}


driver$navigate(url[1])
  
Sys.sleep(1)

cat_html <-driver$getPageSource()[[1]] |>
  read_html() 

cat <- cat_html |> 
   xml_find_all("//label[@class='subhead1-r']") |>
   xml_text()


final <- final |> 
  mutate(cat_name = ifelse((subcat=="Acondicionador y mascarilla"|
                              subcat== "Champú"|
                              subcat== "Coloración cabello"|
                              subcat== "Fijación cabello" ),cat[14], cat[15]))

```

```{r}
#Deslect column ud bacause this column does not contain variation
final <- final |> 
  dplyr::select(-ud)
```


### Brands
```{r}

brands <- c("Deliplus", "Elvive", "Pantene", "O'lysee", 
            "H&S", "Ultrex", "Garnier", "L'Oréal", 
            "Schwarzkopf", "Nelly", "Giorgi", "Elnett", 
            "Fructis", "Syoss", "Gillette", 
            "Nivea", "Axe", "Atlantia", "Bosque Verde", 
            "Montagne Jeunesse", "Viseger Pharma", 
            "My Moment", "Khanya", "Veet", "Wilkinson", 
            "Sanex", "Byly", "Tulipán Negro", "Dove", 
            "Deonat", "Rexona", "Heno de Pravia", "960", 
            "La Toja", "Magno", "Lactovit", "Colgate", 
            "Oral-B", "Sensodyne", "Signal", "Parodontax", 
            "Benfix", "Listerine", "Polident", "evax", 
            "Ausonia", "Carefree", "Tampax", "Tena",
            "Sense", "Classic fresh", "Rose Nude", 
            "Elección", "Prêt à Porter", "Como Tú", 
            "Como Tú", "Psicodelic", "Complicity", "Vuela", 
            "Adidas", "Soplo", "Capítulo Floral", "My soul", 
            "Blue Shine", "Verissime", "Flor de Mayo", 
            "Monogotas", "Capítulo", "Extrait", 
            "Mr. Wonderful", "Uahuu", "TokiDoki", "Ikiru",
            "Chupachups", "Rose Nude", "Rouge seduction",
            "Snoopy", "Muy mío", "Impacto", "Afán", 
            "Springfield", "Gesto", "Sesgo", "Brummel", 
            "Antonio Banderas", "Misty Wood", "Capítulo Marino", "Ego", 
            "My Soul", "Jacq's", "My Soul", "Selk",
            " Crossmen", "Gesto", "Disney", "Marvel", 
            "Naruto", "Peppa Pig", "Sonic de Hedgehog", "Colour up!", 
            "HoneyBotella")


brands_or <- paste(brands, collapse = "|")

final$brand <- str_extract_all(final$name, regex(brands_or, ignore_case = TRUE))

```

### Average prices
```{r}
units <- c("L", "ml", "ud", "sobres", "bandas", "g")

mercadona <- final |> 
  filter(quantity_unit %in% units) |> 
  filter(str_detect(price, "[0-9]")) |> 
  mutate(price = str_replace_all(price, ",", ".")) |> 
  mutate(quantity = as.numeric(quantity),
         price = as.numeric(price)) |> 
  mutate(avg_price = case_when(
    str_detect(quantity_unit, "g|ml") ~ (price/quantity)*100,
    str_detect(quantity_unit, "L") ~ (price/quantity)/100,
    str_detect(quantity_unit, "ud") ~ price /quantity
    )) |> 
   mutate(avg_price = round(avg_price, 2))

```


###Gender product
```{r}
#Vector of words indicating gender
gender <-c("Men", "Women", "Man", "Woman", "Hombre", "Mujer", "Hombres", "Mujeres", "Him", "Her", "Niño", "Niña", "Niños", "Niñas", "Homme", "Femme", "Male", "Female", "Males", "Females", "Venus") 

#Collapsing the gender vector to 
gender_or <- paste(gender, collapse = "|")

mercadona <-mercadona |> 
  mutate(combined =  paste(mercadona$name, mercadona$subcat, sep = " ")) |> 
  mutate(gender_name =  str_extract(combined, regex(paste0("\\b(", gender_or, ")\\b"), ignore_case = TRUE)) ) |> 
  select(-combined)

# Convert NA to 'Non-Male'

mercadona$gender_name[is.na(mercadona$gender_name)] <- "Non-Male"


#Create Male and Female vectors
male <- c("Men", "Man", "Hombre", "Hombres", "Him", "Niño", "Niños", "Homme", "Male",  "Males") 

male <- c(male, tolower(male))

female <- c("Women", "Woman", "Mujer", "Mujeres", "Her", "Niña", "Niñas", "Femme", "Female", "Females", "Venus") 

female <- c(female, tolower(female))

#Assign gender to products (separate column for female)
mercadona$gender <- case_when(
  mercadona$gender_name %in% male | mercadona$subcat %in% male ~ "Male",
  mercadona$gender_name %in% female|mercadona$subcat %in% female ~ "Female",
  mercadona$gender_name == "Non-Male"~ "Non-Male")

#Assign gender to products (separate column for female)
mercadona$gender_2 <- case_when(
  mercadona$gender == "Male" ~ "Male",
  mercadona$gender == "Female" ~ "Non-Male",
  mercadona$gender == "Non-Male"~ "Non-Male")


```

## Mean comparisons
### Categories
```{r}

#Compare all male and non-male products in the category "Cuidado del cabello" in ml, however impossible because no male products
cat_1_m <- mercadona |> 
  filter(cat_name == "Cuidado del cabello" & quantity_unit == "ml")

prices_male <- cat_1_m_ud$avg_price[cat_1_m_ud$gender_2 == "Male"]
prices_non_male <- cat_1_m_ud$avg_price[cat_1_m_ud$gender_2 == "Non-Male"]

# Perform independent samples t-test
t_test_result <- t.test(prices_male, prices_non_male)
t_test_result

#Compare all male and non-male products in the category "Cuidado del cabello" in ud
cat_1_m <- mercadona |> 
  filter(cat_name == "Cuidado del cabello" & quantity_unit == "ml")

cat_1_m_ud <- mercadona |> 
  filter(cat_name == "Cuidado del cabello" & quantity_unit == "ud")

prices_male <- cat_1_m_ud$avg_price[cat_1_m_ud$gender_2 == "Male"]
prices_non_male <- cat_1_m_ud$avg_price[cat_1_m_ud$gender_2 == "Non-Male"]

# Perform independent samples t-test
t_test_result <- t.test(prices_male, prices_non_male)
t_test_result



#Compare all male and non-male products in the category "Cuidado facial y corporal" in ml, however impossible because no male products
cat_2_m <- mercadona |> 
  filter(cat_name == "Cuidado facial y corporal" & quantity_unit == "ml")

prices_male <- cat_2_m$avg_price[cat_2_m$gender_2 == "Male"]
prices_non_male <- cat_2_m$avg_price[cat_2_m$gender_2 == "Non-Male"]

# Perform independent samples t-test
t_test_result <- t.test(prices_male, prices_non_male, alternative = "less")
t_test_result


#Compare all male and non-male products in the category "Cuidado facial y corporal" in ud, however impossible because no male products

cat_2_m_ud <- mercadona |> 
  filter(cat_name == "Cuidado facial y corporal" & quantity_unit == "ud")

prices_male <- cat_2_m_ud$avg_price[cat_2_m_ud$gender_2 == "Male"]
prices_non_male <- cat_2_m_ud$avg_price[cat_2_m_ud$gender_2 == "Non-Male"]

# Perform independent samples t-test
t_test_result <- t.test(prices_male, prices_non_male, alternative = "less")
t_test_result

```

### sub categories
```{r}

cat_1_1_m <- mercadona |> 
  filter(subcat == "Cuidado del cabello" & quantity_unit == "ml")

prices_male <- cat_1_m_ud$avg_price[cat_1_m_ud$gender_2 == "Male"]
prices_non_male <- cat_1_m_ud$avg_price[cat_1_m_ud$gender_2 == "Non-Male"]

# Perform independent samples t-test
t_test_result <- t.test(prices_male, prices_non_male)
t_test_result
```



## Clarel

### Data Collection

```{r}
driver <- rsDriver(browser = "firefox",
                   chromever = NULL,
                   verbose = F)

remDr <- driver[["client"]]
```

#### Main Webpage

```{r}
clarel_url <- "https://www.clarel.es/es/"

remDr$navigate(clarel_url)

Sys.sleep(4)

#Reject cookie
remDr$findElement(using = "xpath", "//button[contains(@class, 'info_cookie-consent-reject-button')]")$clickElement()
```

#### Scrape Hombre Category

```{r}
get_subcat2_url <- function(category){
  remDr$getPageSource()[[1]] %>% 
    read_html() %>% 
    xml_find_all(glue("//span[a[contains(text(),'{category}')]]//li/a[contains(@class,'item')]")) %>% 
    xml_attr("href") %>% 
    paste0("https://www.clarel.es",.)
}
sub_cat_2_url <- get_subcat2_url("Hombre")

remDr$navigate(sub_cat_2_url[10])
```

```{r}
#Load more items
load_all_items <- function() {
  Sys.sleep(3.5)
  tryCatch(
    {
      suppressMessages({
      load_more_button <-remDr$findElement(using = "xpath", 
                                          "//button[contains(@class, 'load-more-items-button')]")
      while(load_more_button$isElementDisplayed()[[1]]) {
      load_more_button$clickElement()
      Sys.sleep(3.5)
      load_more_button <-remDr$findElement(using = "xpath", 
                                           "//button[contains(@class, 'load-more-items-button')]")
      }
      })
    },
    error = function(e){})
}

# load_all_items()
```

```{r}
#Get all product info
get_product_info <- function(url) {
  remDr$navigate(url)
  
  load_all_items()
  
  paths <- read_html(remDr$getPageSource()[[1]]) %>% 
  xml_find_all("//div[contains(@class, 'box_product-info')]")
  
  get_info <- function(path) {
  brand <- path %>% 
    xml_find_all("div[contains(@class, 'product-featuredbrands')]") %>%
    xml_text()
  
  product_name <- path %>% 
    xml_find_all("a") %>% 
    xml_text()
  
  price <- path %>% 
    xml_find_all("div[contains(@class, 'product-price')]/span[contains(@class,'final-price')]") %>% 
    xml_text()
  
  data.frame(
    brand = brand,
    product_name = product_name,
    price = price
  )
  }
  
  #Get cat & subcats
  cat <- remDr$getPageSource()[[1]] %>% 
    read_html() %>% 
    xml_find_all("//span[@class='subcategory']") %>% 
    xml_text() %>% 
    paste(collapse = "-")
  
  df <- map_dfr(paths, get_info) %>% mutate(full_cat = cat)

  
  return(df)
}


hombre_products <- map_dfr(sub_cat_2_url, get_product_info)

hombre_products
```

#### Scrape Multiple Categories

```{r}
imp_cat <- c("Hombre", "Higiene", "Cabello")

scrape_all <- function(category) {
  remDr$navigate(clarel_url)
  
  subcat2 <- get_subcat2_url(category)
  
  df <- map_dfr(subcat2, get_product_info) 
  
  return(df)
}

start <- Sys.time()
all_products_clarel <- map_dfr(imp_cat ,scrape_all)
stop <- Sys.time()

write_csv(all_products_clarel, "datasets/clarel.csv")
```

### Data Cleaning

```{r}

```{r}
#Quantity detect
cleaned_clarel <- all_products_clarel %>% 
  as_tibble() %>% 
  distinct(product_name, .keep_all = TRUE) %>% 
  separate_wider_delim(full_cat, delim = "-", names = c("category", "sub_category", "product_type")) %>% 
  mutate(qty = str_extract(tolower(product_name), "\\d+ ?ml|\\d+ ?g|\\d+ ?u(ds)?|\\d+(,\\d+)? ?l") ,.after = product_name) %>% 
  mutate(qty = replace_na(qty, "1")) %>% 
  mutate(price = parse_number(str_replace(price, "€", ""), locale = locale(decimal_mark = ","))) %>% 
  mutate(
    avg_price = case_when(
      str_detect(qty, "\\d+ ?ml|\\d+ ?g") ~ price * 100 / as.numeric(str_extract(qty, "\\d+")), #price per 100ml/g
      str_detect(qty, "\\d+ ?u(ds)?") ~ price / as.numeric(str_extract(qty, "\\d+")), #price per unit
      str_detect(qty, "\\d+(,\\d+)? ?l") ~ price *0.1 / parse_number(str_extract(qty, "\\d+(,\\d+)? ?l"), locale = locale(decimal_mark = ",")), #price per 100ml for Litters
      TRUE ~ price 
    )
  ) %>% 
  mutate(avg_price = round(avg_price, 2))
  

cleaned_clarel
```

\
\

